<!DOCTYPE html>
<html lang="en"> 
<head>
    <title>ceol.io</title>
    
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
    
    <!-- Theme CSS -->  
    <link id="theme-style" rel="stylesheet" href="./theme.css">
    <link rel="stylesheet" href="https://www.abcjs.net/abcjs-audio.css" type="text/css">
    <style>
		.abcjs-inline-audio {
			max-width: 770px;
		}
    .abcjs-highlight {
    fill: #0a9ecc;
    }
    .abcjs-cursor {
    stroke: red;
    }
	</style>
</head> 

<body>

<h3 id="tune-title"></h3>

<button id="audio-button"></button>
<label for="volumeControl">Volume:</label>
<input type="range" id="volumeControl" min="0" max="2" step="0.01" value="0.75">
<select id="soundfonts">
    <option value="https://gleitz.github.io/midi-js-soundfonts/MusyngKite/">Musyng Kite Soundfont</option>
    <option value="https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/">Fluid Soundfont</option>
    <option value="https://gleitz.github.io/midi-js-soundfonts/FatBoy/">FatBoy Soundfont</option>
    <option value="https://gleitz.github.io/midi-js-soundfonts/Tabla/">Tabla Soundfont</option>
</select>
<select id="instrument-picker">
    <option value="21">accordion</option>
    <option value="40">violin</option>
    <option value="0">acoustic_grand_piano</option>
    <option value="1">bright_acoustic_piano</option>
    <option value="2">electric_grand_piano</option>
    <option value="3">honkytonk_piano</option>
    <option value="4">electric_piano_1</option>
    <option value="5">electric_piano_2</option>
    <option value="6">harpsichord</option>
    <option value="7">clavinet</option>
    <option value="8">celesta</option>
    <option value="9">glockenspiel</option>
    <option value="10">music_box</option>
    <option value="11">vibraphone</option>
    <option value="12">marimba</option>
    <option value="13">xylophone</option>
    <option value="14">tubular_bells</option>
    <option value="15">dulcimer</option>
    <option value="16">drawbar_organ</option>
    <option value="17">percussive_organ</option>
    <option value="18">rock_organ</option>
    <option value="19">church_organ</option>
    <option value="20">reed_organ</option>
    <option value="22">harmonica</option>
    <option value="23">tango_accordion</option>
    <option value="24">acoustic_guitar_nylon</option>
    <option value="25">acoustic_guitar_steel</option>
    <option value="26">electric_guitar_jazz</option>
    <option value="27">electric_guitar_clean</option>
    <option value="28">electric_guitar_muted</option>
    <option value="29">overdriven_guitar</option>
    <option value="30">distortion_guitar</option>
    <option value="31">guitar_harmonics</option>
    <option value="32">acoustic_bass</option>
    <option value="33">electric_bass_finger</option>
    <option value="34">electric_bass_pick</option>
    <option value="35">fretless_bass</option>
    <option value="36">slap_bass_1</option>
    <option value="37">slap_bass_2</option>
    <option value="38">synth_bass_1</option>
    <option value="39">synth_bass_2</option>
    <option value="41">viola</option>
    <option value="42">cello</option>
    <option value="43">contrabass</option>
    <option value="44">tremolo_strings</option>
    <option value="45">pizzicato_strings</option>
    <option value="46">orchestral_harp</option>
    <option value="47">timpani</option>
    <option value="48">string_ensemble_1</option>
    <option value="49">string_ensemble_2</option>
    <option value="50">synth_strings_1</option>
    <option value="51">synth_strings_2</option>
    <option value="52">choir_aahs</option>
    <option value="53">voice_oohs</option>
    <option value="54">synth_choir</option>
    <option value="55">orchestra_hit</option>
    <option value="56">trumpet</option>
    <option value="57">trombone</option>
    <option value="58">tuba</option>
    <option value="59">muted_trumpet</option>
    <option value="60">french_horn</option>
    <option value="61">brass_section</option>
    <option value="62">synth_brass_1</option>
    <option value="63">synth_brass_2</option>
    <option value="64">soprano_sax</option>
    <option value="65">alto_sax</option>
    <option value="66">tenor_sax</option>
    <option value="67">baritone_sax</option>
    <option value="68">oboe</option>
    <option value="69">english_horn</option>
    <option value="70">bassoon</option>
    <option value="71">clarinet</option>
    <option value="72">piccolo</option>
    <option value="73">flute</option>
    <option value="74">recorder</option>
    <option value="75">pan_flute</option>
    <option value="76">blown_bottle</option>
    <option value="77">shakuhachi</option>
    <option value="78">whistle</option>
    <option value="79">ocarina</option>
    <option value="80">lead_1_square</option>
    <option value="81">lead_2_sawtooth</option>
    <option value="82">lead_3_calliope</option>
    <option value="83">lead_4_chiff</option>
    <option value="84">lead_5_charang</option>
    <option value="85">lead_6_voice</option>
    <option value="86">lead_7_fifths</option>
    <option value="87">lead_8_bass__lead</option>
    <option value="88">pad_1_new_age</option>
    <option value="89">pad_2_warm</option>
    <option value="90">pad_3_polysynth</option>
    <option value="91">pad_4_choir</option>
    <option value="92">pad_5_bowed</option>
    <option value="93">pad_6_metallic</option>
    <option value="94">pad_7_halo</option>
    <option value="95">pad_8_sweep</option>
    <option value="96">fx_1_rain</option>
    <option value="97">fx_2_soundtrack</option>
    <option value="98">fx_3_crystal</option>
    <option value="99">fx_4_atmosphere</option>
    <option value="100">fx_5_brightness</option>
    <option value="101">fx_6_goblins</option>
    <option value="102">fx_7_echoes</option>
    <option value="103">fx_8_scifi</option>
    <option value="104">sitar</option>
    <option value="105">banjo</option>
    <option value="106">shamisen</option>
    <option value="107">koto</option>
    <option value="108">kalimba</option>
    <option value="109">bagpipe</option>
    <option value="110">fiddle</option>
    <option value="111">shanai</option>
    <option value="112">tinkle_bell</option>
    <option value="113">agogo</option>
    <option value="114">steel_drums</option>
    <option value="115">woodblock</option>
    <option value="116">taiko_drum</option>
    <option value="117">melodic_tom</option>
    <option value="118">synth_drum</option>
    <option value="119">reverse_cymbal</option>
    <option value="120">guitar_fret_noise</option>
    <option value="121">breath_noise</option>
    <option value="122">seashore</option>
    <option value="123">bird_tweet</option>
    <option value="124">telephone_ring</option>
    <option value="125">helicopter</option>
    <option value="126">applause</option>
    <option value="127">gunshot</option>
</select>


<div class="container">
  <div id="paper"></div>
  <div id="audio"></div>
</div>

<h3>Sets Where this tune was played:</h3>

<ul id="sets-body"></ul>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.0.0/abcjs-basic.min.js"></script>
    <script>

        var synthControl;


        async function fetchSets(tune_id) {
          let abcNotation = ''
            try {
              const response = await fetch(`/tune?tune_id=${tune_id}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const data = await response.json();
                populateSets(data);
            } catch (error) {
                console.error('Error fetching the top tunes:', error);
                document.getElementById('tunes-body').innerHTML = `<tr><td colspan="2">Error fetching data. Please try again later.</td></tr>`;
            }
          return abcNotation;
        }
        function populateSets(sets){
            const tableBody = document.getElementById('sets-body');
            tableBody.innerHTML = ''; // Clear existing rows

            sets.forEach(set => {
                const row = document.createElement('li');
                row.innerHTML = `
                  <a>${set.description}</a>
                `;
                row.onclick = function() {
                    window.parent.changeSetFrame(`set.html?set_id=${set.set_id}&description=${set.description}`)
                }
                row.style = "cursor: pointer"
                tableBody.appendChild(row);
            });
        }

        async function fetchABC(tune_id) {
          let abcNotation = ''
            try {
              const response = await fetch(`/abc?tune_id=${tune_id}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const data = await response.json();
                abcNotation = 
                'X: 1\n' +
                `T: ${data[0].name}\n` +
                `M: ${data[0].tune_meter}\n` +
                `K: ${data[0].tune_mode}\n` +
                `${data[0].abc}\n`
                
            } catch (error) {
                console.error('Error fetching the top tunes:', error);
                document.getElementById('tunes-body').innerHTML = `<tr><td colspan="2">Error fetching data. Please try again later.</td></tr>`;
            }
          return abcNotation;
        }



        async function initPageData() {
          const params = new URLSearchParams(window.location.search); // Get query parameters
          await fetchSets(params.get('tune_id'));
          audio_button  = document.getElementById('audio-button')
          audio_button.textContent = 'Generate Player'
          const abcNotation = await fetchABC(params.get('tune_id'));
          audio_button.onclick = function() {
            renderAudio(abcNotation)
          }
          tune_header = document.createElement('a')
          tune_header.textContent = params.get('name')
          tune_header.href = params.get('tune_url')
          tune_header.target = "_blank"
          document.getElementById('tune-title').appendChild(tune_header)

          document.getElementById('volumeControl').addEventListener('click', function() {
            renderAudio(abcNotation);
          })

          document.getElementById('soundfonts').addEventListener('click', function() {
            renderAudio(abcNotation);
          })

          document.getElementById('instrument-picker').addEventListener('click', function() {
            renderAudio(abcNotation);
          })

        }

        function renderAudio(abcNotation) {
          if (ABCJS.synth.supportsAudio()) {
              console.log(abcNotation)
              const volume = parseFloat(document.getElementById('volumeControl').value)
              const instrument = Number(document.getElementById('instrument-picker').value)
              const fontURL = document.getElementById('soundfonts').value
              var visualOptions = {  };
              var visualObj = ABCJS.renderAbc("paper", abcNotation);
              var controlOptions = {
                  displayRestart: true,
                  displayPlay: true,
                  displayProgress: true,
                  displayClock: true,
                  displayWarp: true
              };
              var synthControl = new ABCJS.synth.SynthController();
              synthControl.load("#audio", cursorControl, controlOptions);
              synthControl.setTune(visualObj[0], false, {
                  program: instrument,
                  soundFontUrl: fontURL,
                  soundFontVolumeMultiplier: volume,
              })
              } else {
              document.querySelector("#audio").innerHTML = "<div class='audio-error'>Audio is not supported in this browser.</div>";
          }
        }

  function CursorControl(rootSelector) {
    var self = this;

    self.cursor = null;
    self.rootSelector = rootSelector;

    self.onStart = function() {
        var svg = document.querySelector(self.rootSelector + " svg");
        self.cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
        self.cursor.setAttribute("class", "abcjs-cursor");
        self.cursor.setAttributeNS(null, 'x1', 0);
        self.cursor.setAttributeNS(null, 'y1', 0);
        self.cursor.setAttributeNS(null, 'x2', 0);
        self.cursor.setAttributeNS(null, 'y2', 0);
        svg.appendChild(self.cursor);
    };

    self.removeSelection = function() {
        var lastSelection = document.querySelectorAll(self.rootSelector + " .abcjs-highlight");
        for (var k = 0; k < lastSelection.length; k++)
            lastSelection[k].classList.remove("abcjs-highlight");
    };


    self.onEvent = function(ev) {
        if (ev.measureStart && ev.left === null)
            return; 

        self.removeSelection();

        for (var i = 0; i < ev.elements.length; i++ ) {
            var note = ev.elements[i];
            for (var j = 0; j < note.length; j++) {
                note[j].classList.add("abcjs-highlight");
            }
        }

        if (self.cursor) {
            self.cursor.setAttribute("x1", ev.left - 2);
            self.cursor.setAttribute("x2", ev.left - 2);
            self.cursor.setAttribute("y1", ev.top);
            self.cursor.setAttribute("y2", ev.top + ev.height);
        }
    };
    self.onFinished = function() {
            self.removeSelection();

        if (self.cursor) {
            self.cursor.setAttribute("x1", 0);
            self.cursor.setAttribute("x2", 0);
            self.cursor.setAttribute("y1", 0);
            self.cursor.setAttribute("y2", 0);
        }

    };
}

var cursorControl = new CursorControl("#paper");

function onEvent(ev) {
if (ev)
cursorControl.onEvent(ev);
else
cursorControl.onFinished();
}

function startTimer() {
    cursorControl.onStart();

var timingCallbacks = new ABCJS.TimingCallbacks(visualObj[0], {
    eventCallback: onEvent
});
timingCallbacks.start();
}
        document.addEventListener('DOMContentLoaded', initPageData, { responsive: 'resize' });




    </script>

<!-- end landing page -->
</body>
</html>
